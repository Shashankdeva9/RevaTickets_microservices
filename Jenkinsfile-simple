pipeline {
    agent any
    
    environment {
        DOCKER_HUB_CREDENTIALS = credentials('docker-hub-credentials')
        DOCKER_HUB_REPO = 'shashank092'
    }
    
    options {
        timeout(time: 2, unit: 'HOURS')
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "â³ Checking out code from repository..."
                }
                git branch: 'main', url: 'https://github.com/Shashankdeva9/RevaTickets_microservices.git'
                script {
                    echo "âœ… Code checkout completed"
                }
            }
        }
        
        stage('Build Services') {
            parallel {
                stage('Build Eureka JAR') {
                    steps {
                        dir('microservices/eureka-server') {
                            script {
                                echo "â³ Building Eureka Server..."
                            }
                            bat 'mvn clean package -DskipTests'
                            script {
                                echo "âœ… Eureka Server built successfully"
                            }
                        }
                    }
                }
                stage('Build API Gateway JAR') {
                    steps {
                        dir('microservices/api-gateway') {
                            script {
                                echo "â³ Building API Gateway..."
                            }
                            bat 'mvn clean package -DskipTests'
                            script {
                                echo "âœ… API Gateway built successfully"
                            }
                        }
                    }
                }
                stage('Build User Service JAR') {
                    steps {
                        dir('microservices/user-service') {
                            script {
                                echo "â³ Building User Service..."
                            }
                            bat 'mvn clean package -DskipTests'
                            script {
                                echo "âœ… User Service built successfully"
                            }
                        }
                    }
                }
                stage('Build Movie Service JAR') {
                    steps {
                        dir('microservices/movie-service') {
                            script {
                                echo "â³ Building Movie Service..."
                            }
                            bat 'mvn clean package -DskipTests'
                            script {
                                echo "âœ… Movie Service built successfully"
                            }
                        }
                    }
                }
                stage('Build Venue Service JAR') {
                    steps {
                        dir('microservices/venue-service') {
                            script {
                                echo "â³ Building Venue Service..."
                            }
                            bat 'mvn clean package -DskipTests'
                            script {
                                echo "âœ… Venue Service built successfully"
                            }
                        }
                    }
                }
                stage('Build Booking Service JAR') {
                    steps {
                        dir('microservices/booking-service') {
                            script {
                                echo "â³ Building Booking Service..."
                            }
                            bat 'mvn clean package -DskipTests'
                            script {
                                echo "âœ… Booking Service built successfully"
                            }
                        }
                    }
                }
                stage('Build Payment Service JAR') {
                    steps {
                        dir('microservices/payment-service') {
                            script {
                                echo "â³ Building Payment Service..."
                            }
                            bat 'mvn clean package -DskipTests'
                            script {
                                echo "âœ… Payment Service built successfully"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Images') {
            parallel {
                stage('Build Eureka') {
                    steps {
                        dir('microservices/eureka-server') {
                            script {
                                echo "â³ Building Eureka Docker image..."
                            }
                            bat 'docker build --pull=always -t %DOCKER_HUB_REPO%/revtickets-eureka-server:latest .'
                            script {
                                echo "âœ… Eureka Docker image built"
                            }
                        }
                    }
                }
                stage('Build API Gateway') {
                    steps {
                        dir('microservices/api-gateway') {
                            script {
                                echo "â³ Building API Gateway Docker image..."
                            }
                            bat 'docker build --pull=always -t %DOCKER_HUB_REPO%/revtickets-api-gateway:latest .'
                            script {
                                echo "âœ… API Gateway Docker image built"
                            }
                        }
                    }
                }
                stage('Build User Service') {
                    steps {
                        dir('microservices/user-service') {
                            script {
                                echo "â³ Building User Service Docker image..."
                            }
                            bat 'docker build --pull=always -t %DOCKER_HUB_REPO%/revtickets-user-service:latest .'
                            script {
                                echo "âœ… User Service Docker image built"
                            }
                        }
                    }
                }
                stage('Build Movie Service') {
                    steps {
                        dir('microservices/movie-service') {
                            script {
                                echo "â³ Building Movie Service Docker image..."
                            }
                            bat 'docker build --pull=always -t %DOCKER_HUB_REPO%/revtickets-movie-service:latest .'
                            script {
                                echo "âœ… Movie Service Docker image built"
                            }
                        }
                    }
                }
                stage('Build Venue Service') {
                    steps {
                        dir('microservices/venue-service') {
                            script {
                                echo "â³ Building Venue Service Docker image..."
                            }
                            bat 'docker build --pull=always -t %DOCKER_HUB_REPO%/revtickets-venue-service:latest .'
                            script {
                                echo "âœ… Venue Service Docker image built"
                            }
                        }
                    }
                }
                stage('Build Booking Service') {
                    steps {
                        dir('microservices/booking-service') {
                            script {
                                echo "â³ Building Booking Service Docker image..."
                            }
                            bat 'docker build --pull=always -t %DOCKER_HUB_REPO%/revtickets-booking-service:latest .'
                            script {
                                echo "âœ… Booking Service Docker image built"
                            }
                        }
                    }
                }
                stage('Build Payment Service') {
                    steps {
                        dir('microservices/payment-service') {
                            script {
                                echo "â³ Building Payment Service Docker image..."
                            }
                            bat 'docker build --pull=always -t %DOCKER_HUB_REPO%/revtickets-payment-service:latest .'
                            script {
                                echo "âœ… Payment Service Docker image built"
                            }
                        }
                    }
                }
                stage('Build Frontend') {
                    steps {
                        dir('frontend') {
                            script {
                                echo "â³ Building Frontend Docker image..."
                            }
                            bat 'docker build --pull=always -t %DOCKER_HUB_REPO%/revtickets-frontend:latest .'
                            script {
                                echo "âœ… Frontend Docker image built"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Login to Docker Hub') {
            steps {
                script {
                    echo "â³ Logging in to Docker Hub..."
                }
                bat 'echo %DOCKER_HUB_CREDENTIALS_PSW% | docker login -u %DOCKER_HUB_CREDENTIALS_USR% --password-stdin'
                script {
                    echo "âœ… Docker Hub login successful"
                }
            }
        }
        
        stage('Push Images') {
            parallel {
                stage('Push Eureka') {
                    steps {
                        script {
                            echo "â³ Pushing Eureka image..."
                        }
                        bat 'docker push %DOCKER_HUB_REPO%/revtickets-eureka-server:latest'
                        script {
                            echo "âœ… Eureka image pushed"
                        }
                    }
                }
                stage('Push API Gateway') {
                    steps {
                        script {
                            echo "â³ Pushing API Gateway image..."
                        }
                        bat 'docker push %DOCKER_HUB_REPO%/revtickets-api-gateway:latest'
                        script {
                            echo "âœ… API Gateway image pushed"
                        }
                    }
                }
                stage('Push User Service') {
                    steps {
                        script {
                            echo "â³ Pushing User Service image..."
                        }
                        bat 'docker push %DOCKER_HUB_REPO%/revtickets-user-service:latest'
                        script {
                            echo "âœ… User Service image pushed"
                        }
                    }
                }
                stage('Push Movie Service') {
                    steps {
                        script {
                            echo "â³ Pushing Movie Service image..."
                        }
                        bat 'docker push %DOCKER_HUB_REPO%/revtickets-movie-service:latest'
                        script {
                            echo "âœ… Movie Service image pushed"
                        }
                    }
                }
                stage('Push Venue Service') {
                    steps {
                        script {
                            echo "â³ Pushing Venue Service image..."
                        }
                        bat 'docker push %DOCKER_HUB_REPO%/revtickets-venue-service:latest'
                        script {
                            echo "âœ… Venue Service image pushed"
                        }
                    }
                }
                stage('Push Booking Service') {
                    steps {
                        script {
                            echo "â³ Pushing Booking Service image..."
                        }
                        bat 'docker push %DOCKER_HUB_REPO%/revtickets-booking-service:latest'
                        script {
                            echo "âœ… Booking Service image pushed"
                        }
                    }
                }
                stage('Push Payment Service') {
                    steps {
                        script {
                            echo "â³ Pushing Payment Service image..."
                        }
                        bat 'docker push %DOCKER_HUB_REPO%/revtickets-payment-service:latest'
                        script {
                            echo "âœ… Payment Service image pushed"
                        }
                    }
                }
                stage('Push Frontend') {
                    steps {
                        script {
                            echo "â³ Pushing Frontend image..."
                        }
                        bat 'docker push %DOCKER_HUB_REPO%/revtickets-frontend:latest'
                        script {
                            echo "âœ… Frontend image pushed"
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            bat 'docker logout'
        }
        success {
            script {
                echo ""
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "ğŸ‰ BUILD SUCCESSFUL ğŸ‰"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "Build Number: #${BUILD_NUMBER}"
                echo "Build Duration: ${currentBuild.durationString}"
                echo "Build Status: SUCCESS âœ…"
                echo "Timestamp: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
                echo ""
                echo "All Docker images built and pushed successfully!"
                echo ""
                echo "ğŸ“¦ Docker Images Created:"
                echo "  âœ… shashank092/revtickets-eureka-server:latest"
                echo "  âœ… shashank092/revtickets-api-gateway:latest"
                echo "  âœ… shashank092/revtickets-user-service:latest"
                echo "  âœ… shashank092/revtickets-movie-service:latest"
                echo "  âœ… shashank092/revtickets-venue-service:latest"
                echo "  âœ… shashank092/revtickets-booking-service:latest"
                echo "  âœ… shashank092/revtickets-payment-service:latest"
                echo "  âœ… shashank092/revtickets-frontend:latest"
                echo ""
                echo "ğŸš€ Ready for deployment!"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
            }
        }
        failure {
            script {
                echo ""
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "âŒ BUILD FAILED âŒ"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "Build Number: #${BUILD_NUMBER}"
                echo "Build Duration: ${currentBuild.durationString}"
                echo "Build Status: FAILED âŒ"
                echo "Timestamp: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
                echo ""
                echo "Please check the build logs above for details."
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
            }
        }
    }
}