pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'shashankdeva9'  // Your Docker Hub username
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'
    }
    
    stages {
        stage('Build Maven Projects') {
            parallel {
                stage('Eureka Server') {
                    steps {
                        dir('microservices/eureka-server') {
                            bat 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('API Gateway') {
                    steps {
                        dir('microservices/api-gateway') {
                            bat 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('User Service') {
                    steps {
                        dir('microservices/user-service') {
                            bat 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('Movie Service') {
                    steps {
                        dir('microservices/movie-service') {
                            bat 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('Venue Service') {
                    steps {
                        dir('microservices/venue-service') {
                            bat 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('Booking Service') {
                    steps {
                        dir('microservices/booking-service') {
                            bat 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('Payment Service') {
                    steps {
                        dir('microservices/payment-service') {
                            bat 'mvn clean package -DskipTests'
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Images') {
            steps {
                script {
                    echo 'Building Docker images...'
                    
                    bat 'docker build -t %DOCKER_REGISTRY%/revtickets-eureka:latest ./microservices/eureka-server'
                    bat 'docker build -t %DOCKER_REGISTRY%/revtickets-gateway:latest ./microservices/api-gateway'
                    bat 'docker build -t %DOCKER_REGISTRY%/revtickets-user:latest ./microservices/user-service'
                    bat 'docker build -t %DOCKER_REGISTRY%/revtickets-movie:latest ./microservices/movie-service'
                    bat 'docker build -t %DOCKER_REGISTRY%/revtickets-venue:latest ./microservices/venue-service'
                    bat 'docker build -t %DOCKER_REGISTRY%/revtickets-booking:latest ./microservices/booking-service'
                    bat 'docker build -t %DOCKER_REGISTRY%/revtickets-payment:latest ./microservices/payment-service'
                    bat 'docker build -t %DOCKER_REGISTRY%/revtickets-frontend:latest ./frontend'
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDENTIALS_ID}", 
                                                passwordVariable: 'DOCKER_PASSWORD', 
                                                usernameVariable: 'DOCKER_USERNAME')]) {
                    script {
                        bat 'docker login -u %DOCKER_USERNAME% -p %DOCKER_PASSWORD%'
                        
                        bat 'docker push %DOCKER_REGISTRY%/revtickets-eureka:latest'
                        bat 'docker push %DOCKER_REGISTRY%/revtickets-gateway:latest'
                        bat 'docker push %DOCKER_REGISTRY%/revtickets-user:latest'
                        bat 'docker push %DOCKER_REGISTRY%/revtickets-movie:latest'
                        bat 'docker push %DOCKER_REGISTRY%/revtickets-venue:latest'
                        bat 'docker push %DOCKER_REGISTRY%/revtickets-booking:latest'
                        bat 'docker push %DOCKER_REGISTRY%/revtickets-payment:latest'
                        bat 'docker push %DOCKER_REGISTRY%/revtickets-frontend:latest'
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'All Docker images built and pushed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
        always {
            bat 'docker logout'
        }
    }
}